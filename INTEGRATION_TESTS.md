# WalletBot é›†æˆæµ‹è¯•æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº† WalletBot é¡¹ç›®çš„é›†æˆæµ‹è¯•å®ç°ï¼ŒåŒ…å«äº†å®Œæ•´çš„ Telegram Bot API Mock å®ç°å’Œå…¨é¢çš„æµ‹è¯•ç”¨ä¾‹ã€‚

## æµ‹è¯•æ¶æ„

### 1. Mock ç³»ç»Ÿ

#### MockBotApi
- å®ç°äº† `BotApi` traitï¼Œæä¾›å®Œæ•´çš„ Telegram Bot API mock
- æ”¯æŒæ¶ˆæ¯å‘é€ã€ç¼–è¾‘ã€åˆ é™¤ç­‰æ“ä½œ
- æ”¯æŒé”™è¯¯æ¨¡æ‹Ÿï¼Œå¯ä»¥æµ‹è¯•å¼‚å¸¸æƒ…å†µ
- è®°å½•æ‰€æœ‰APIè°ƒç”¨ä»¥ä¾›éªŒè¯

#### ç‰¹æ€§
- **æ¶ˆæ¯è¿½è¸ª**: è®°å½•æ‰€æœ‰å‘é€ã€ç¼–è¾‘ã€åˆ é™¤çš„æ¶ˆæ¯
- **é”™è¯¯æ¨¡æ‹Ÿ**: å¯ä»¥è®¾ç½®å¤±è´¥çŠ¶æ€æ¥æµ‹è¯•é”™è¯¯å¤„ç†
- **å¼‚æ­¥æ”¯æŒ**: å®Œå…¨å¼‚æ­¥å®ç°ï¼Œç¬¦åˆçœŸå®APIè¡Œä¸º
- **ç±»å‹å®‰å…¨**: ä½¿ç”¨çœŸå®çš„ teloxide ç±»å‹ï¼Œç¡®ä¿å…¼å®¹æ€§

### 2. æµ‹è¯•åˆ†ç±»

#### åŸºç¡€åŠŸèƒ½æµ‹è¯•
- **æ¶ˆæ¯è§£æå™¨æµ‹è¯•** (`test_message_parser`)
  - æµ‹è¯•é’±åŒ…æ¶ˆæ¯æ ¼å¼è§£æ
  - æµ‹è¯•éé’±åŒ…æ¶ˆæ¯è¯†åˆ«
  - æµ‹è¯•æ€»é¢æå–åŠŸèƒ½

- **æ•°æ®åº“æ“ä½œæµ‹è¯•** (`test_database_operations`)
  - æµ‹è¯•é’±åŒ…åˆ›å»ºå’Œæ›´æ–°
  - æµ‹è¯•äº¤æ˜“è®°å½•
  - æµ‹è¯•æ¶ˆæ¯å¤„ç†çŠ¶æ€è®°å½•

- **Mock APIæµ‹è¯•** (`test_mock_bot_api`)
  - æµ‹è¯•æ¶ˆæ¯å‘é€ã€ç¼–è¾‘ã€åˆ é™¤
  - æµ‹è¯•é”™è¯¯å¤„ç†
  - æµ‹è¯•APIè°ƒç”¨è®°å½•

#### ä¸šåŠ¡é€»è¾‘æµ‹è¯•
- **å®Œæ•´æ¶ˆæ¯æµç¨‹æµ‹è¯•** (`test_complete_message_flow`)
  - æµ‹è¯•å¤šä¸ªé’±åŒ…çš„äº¤æ˜“å¤„ç†
  - éªŒè¯æ¶ˆæ¯è§£æå’Œæ•°æ®åº“æ“ä½œçš„å®Œæ•´æµç¨‹

- **é”™è¯¯å¤„ç†æµ‹è¯•** (`test_error_handling`)
  - æµ‹è¯•å„ç§æ— æ•ˆæ¶ˆæ¯æ ¼å¼
  - éªŒè¯é”™è¯¯æƒ…å†µä¸‹çš„è¡Œä¸º

- **é‡å¤æ¶ˆæ¯å¤„ç†æµ‹è¯•** (`test_duplicate_message_handling`)
  - æµ‹è¯•æ¶ˆæ¯å»é‡æœºåˆ¶
  - éªŒè¯é‡å¤æ¶ˆæ¯ä¸ä¼šè¢«é‡å¤å¤„ç†

#### æ€§èƒ½å’Œå¹¶å‘æµ‹è¯•
- **æ€§èƒ½æµ‹è¯•** (`test_performance`)
  - æµ‹è¯•æ¶ˆæ¯è§£ææ€§èƒ½
  - æµ‹è¯•æ•°æ®åº“æ“ä½œæ€§èƒ½
  - æä¾›è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡

- **å¹¶å‘æµ‹è¯•** (`test_concurrent_operations`)
  - æµ‹è¯•å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ•°æ®åº“æ“ä½œ
  - éªŒè¯å¹¶å‘å®‰å…¨æ€§

## è¿è¡Œæµ‹è¯•

### ç¯å¢ƒå‡†å¤‡

1. ç¡®ä¿ Rust ç¯å¢ƒå·²æ­£ç¡®å®‰è£…
2. å®‰è£…é¡¹ç›®ä¾èµ–ï¼š
   ```bash
   cargo build
   ```

### è¿è¡Œæµ‹è¯•

#### è¿è¡Œæ‰€æœ‰é›†æˆæµ‹è¯•
```bash
cargo test --test integration_tests
```

#### è¿è¡Œå•ä¸ªæµ‹è¯•
```bash
cargo test --test integration_tests test_message_parser
```

#### è¿è¡Œç‰¹å®šåˆ†ç±»çš„æµ‹è¯•
```bash
# è¿è¡ŒåŸºç¡€åŠŸèƒ½æµ‹è¯•
cargo test --test integration_tests test_message_parser test_database_operations test_mock_bot_api

# è¿è¡Œä¸šåŠ¡é€»è¾‘æµ‹è¯•
cargo test --test integration_tests test_complete_message_flow test_error_handling

# è¿è¡Œæ€§èƒ½æµ‹è¯•
cargo test --test integration_tests test_performance
```

#### æŸ¥çœ‹è¯¦ç»†è¾“å‡º
```bash
cargo test --test integration_tests -- --nocapture
```

### æµ‹è¯•ç»“æœè¯´æ˜

#### æˆåŠŸè¾“å‡ºç¤ºä¾‹
```
ğŸ§ª å¼€å§‹WalletBoté›†æˆæµ‹è¯•...
âœ… æ¶ˆæ¯è§£æå™¨æµ‹è¯•é€šè¿‡
âœ… æ•°æ®åº“æ“ä½œæµ‹è¯•é€šè¿‡
âœ… Mock Bot APIæµ‹è¯•é€šè¿‡
âœ… å®Œæ•´æ¶ˆæ¯å¤„ç†æµç¨‹æµ‹è¯•é€šè¿‡
âœ… é”™è¯¯å¤„ç†æµ‹è¯•é€šè¿‡
âœ… é‡å¤æ¶ˆæ¯å¤„ç†æµ‹è¯•é€šè¿‡
âœ… æ€§èƒ½æµ‹è¯•ç»“æœ:
  - 1000æ¬¡æ¶ˆæ¯è§£æè€—æ—¶: 45.2ms
  - 100æ¬¡æ•°æ®åº“æ“ä½œè€—æ—¶: 234.1ms
  - å¹³å‡å•æ¬¡è§£æè€—æ—¶: 45.2Âµs
  - å¹³å‡å•æ¬¡æ•°æ®åº“æ“ä½œè€—æ—¶: 2.341ms
âœ… å¹¶å‘æ“ä½œæµ‹è¯•é€šè¿‡
ğŸ‰ æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡!
```

## æµ‹è¯•ç”¨ä¾‹è¯¦ç»†è¯´æ˜

### 1. æ¶ˆæ¯è§£æå™¨æµ‹è¯•

æµ‹è¯•ä»¥ä¸‹åœºæ™¯ï¼š
- æ ‡å‡†é’±åŒ…äº¤æ˜“æ¶ˆæ¯ï¼š`#æ”¯ä»˜å® #12æœˆ #2024å¹´\n#å‡ºè´¦ 150.00å…ƒ`
- åŒ…å«æ€»é¢çš„æ¶ˆæ¯ï¼š`#æ”¯ä»˜å® #12æœˆ #2024å¹´\n#å‡ºè´¦ 150.00å…ƒ\n#æ€»é¢ 1000.00å…ƒ`
- éé’±åŒ…æ¶ˆæ¯ï¼š`è¿™æ˜¯ä¸€ä¸ªæ™®é€šæ¶ˆæ¯`

### 2. æ•°æ®åº“æ“ä½œæµ‹è¯•

æµ‹è¯•ä»¥ä¸‹æ“ä½œï¼š
- åˆ›å»ºæ–°é’±åŒ…
- æ›´æ–°é’±åŒ…ä½™é¢
- è®°å½•äº¤æ˜“
- è®°å½•æ¶ˆæ¯å¤„ç†çŠ¶æ€
- æ£€æŸ¥æ¶ˆæ¯é‡å¤å¤„ç†

### 3. Mock Bot APIæµ‹è¯•

æµ‹è¯•ä»¥ä¸‹APIæ“ä½œï¼š
- å‘é€æ¶ˆæ¯
- ç¼–è¾‘æ¶ˆæ¯
- åˆ é™¤æ¶ˆæ¯
- å›å¤æ¶ˆæ¯
- é”™è¯¯å¤„ç†

### 4. å®Œæ•´æ¶ˆæ¯å¤„ç†æµç¨‹æµ‹è¯•

æµ‹è¯•å®Œæ•´çš„ä¸šåŠ¡æµç¨‹ï¼š
1. æ¥æ”¶é’±åŒ…äº¤æ˜“æ¶ˆæ¯
2. è§£ææ¶ˆæ¯å†…å®¹
3. æ›´æ–°æ•°æ®åº“
4. è¿”å›å¤„ç†ç»“æœ

### 5. é”™è¯¯å¤„ç†æµ‹è¯•

æµ‹è¯•å„ç§é”™è¯¯æƒ…å†µï¼š
- æ— æ•ˆæ¶ˆæ¯æ ¼å¼
- ç¼ºå°‘å¿…éœ€å­—æ®µ
- æ— æ•ˆé‡‘é¢æ ¼å¼
- æ•°æ®åº“æ“ä½œå¤±è´¥

### 6. æ€§èƒ½æµ‹è¯•

æµ‹è¯•å…³é”®æ“ä½œçš„æ€§èƒ½ï¼š
- æ¶ˆæ¯è§£æé€Ÿåº¦
- æ•°æ®åº“æ“ä½œé€Ÿåº¦
- å¹³å‡å“åº”æ—¶é—´

## æµ‹è¯•é…ç½®

### æµ‹è¯•ä¾èµ–

- `tokio-test`: å¼‚æ­¥æµ‹è¯•æ”¯æŒ
- `mockall`: Mockå¯¹è±¡åˆ›å»º
- `tempfile`: ä¸´æ—¶æ–‡ä»¶ç®¡ç†
- `serial_test`: ä¸²è¡Œæµ‹è¯•æ‰§è¡Œ
- `wiremock`: HTTP MockæœåŠ¡å™¨
- `httpmock`: HTTPæµ‹è¯•å·¥å…·
- `rand`: éšæœºæ•°ç”Ÿæˆ
- `async-trait`: å¼‚æ­¥traitæ”¯æŒ

### æµ‹è¯•ç‰¹æ€§

åœ¨ `Cargo.toml` ä¸­é…ç½®äº†æµ‹è¯•ç‰¹æ€§ï¼š

```toml
[features]
default = []
testing = []
```

## æ‰©å±•æµ‹è¯•

### æ·»åŠ æ–°çš„æµ‹è¯•ç”¨ä¾‹

1. åœ¨ `tests/integration_tests.rs` ä¸­æ·»åŠ æ–°çš„æµ‹è¯•å‡½æ•°
2. ä½¿ç”¨ `#[tokio::test]` å’Œ `#[serial]` æ ‡è®°
3. ä½¿ç”¨ `MockBotApi` è¿›è¡ŒAPIæ“ä½œmock
4. ä½¿ç”¨ `create_test_db()` åˆ›å»ºæµ‹è¯•æ•°æ®åº“

### ç¤ºä¾‹ï¼šæ·»åŠ æ–°çš„æµ‹è¯•ç”¨ä¾‹

```rust
#[tokio::test]
#[serial]
async fn test_new_feature() -> Result<()> {
    let db = create_test_db().await?;
    let mock_bot = MockBotApi::new();
    
    // æµ‹è¯•é€»è¾‘
    
    println!("âœ… æ–°åŠŸèƒ½æµ‹è¯•é€šè¿‡");
    Ok(())
}
```

## æŒç»­é›†æˆ

### CI/CD é…ç½®

åœ¨ CI/CD ç®¡é“ä¸­è¿è¡Œæµ‹è¯•ï¼š

```yaml
- name: Run Integration Tests
  run: |
    cargo test --test integration_tests --verbose
```

### æµ‹è¯•è¦†ç›–ç‡

ä½¿ç”¨ `cargo-tarpaulin` æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡ï¼š

```bash
cargo tarpaulin --tests
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æµ‹è¯•æ•°æ®åº“é”å®š**
   - ä½¿ç”¨ `#[serial]` æ ‡è®°ç¡®ä¿æµ‹è¯•ä¸²è¡Œæ‰§è¡Œ
   - ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶é¿å…æ•°æ®åº“å†²çª

2. **å¼‚æ­¥æµ‹è¯•è¶…æ—¶**
   - ç¡®ä¿ä½¿ç”¨ `#[tokio::test]` æ ‡è®°
   - æ£€æŸ¥å¼‚æ­¥æ“ä½œæ˜¯å¦æ­£ç¡®ç­‰å¾…

3. **Mockå¯¹è±¡çŠ¶æ€æ··ä¹±**
   - åœ¨æµ‹è¯•å‰è°ƒç”¨ `mock_bot.clear_all().await`
   - ç¡®ä¿æµ‹è¯•é—´ç›¸äº’ç‹¬ç«‹

### è°ƒè¯•æŠ€å·§

1. ä½¿ç”¨ `-- --nocapture` æŸ¥çœ‹å®Œæ•´è¾“å‡º
2. åœ¨æµ‹è¯•ä¸­æ·»åŠ  `println!` è°ƒè¯•ä¿¡æ¯
3. ä½¿ç”¨ `cargo test --test integration_tests -- --test-threads=1` å¼ºåˆ¶å•çº¿ç¨‹è¿è¡Œ

## æ€»ç»“

æœ¬é›†æˆæµ‹è¯•ç³»ç»Ÿæä¾›äº†ï¼š
- å®Œæ•´çš„ Telegram Bot API mock
- å…¨é¢çš„åŠŸèƒ½æµ‹è¯•è¦†ç›–
- æ€§èƒ½å’Œå¹¶å‘æµ‹è¯•
- æ˜“äºæ‰©å±•çš„æµ‹è¯•æ¡†æ¶

é€šè¿‡è¿™äº›æµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿ WalletBot åœ¨å„ç§æƒ…å†µä¸‹éƒ½èƒ½æ­£ç¡®å·¥ä½œï¼Œå¹¶ä¸”å…·æœ‰è‰¯å¥½çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚ 