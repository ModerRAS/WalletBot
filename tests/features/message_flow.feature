# language: zh-CN
功能: 完整消息流处理
  作为一个钱包机器人
  我需要能够处理完整的消息流程
  从接收消息到更新余额和发送回复

  背景:
    假设 系统已经完整初始化

  场景: 处理收入消息的完整流程
    假设 频道 "12345" 已经有钱包 "支付宝"
    并且 用户在频道 "12345" 发送消息 "#支付宝 #12月 #2024年\n#收入 200.00元"
    当 我处理这条消息
    那么 消息应该解析成功
    并且 交易应该记录到数据库
    并且 钱包余额应该增加 200.00
    并且 应该发送确认消息给用户
    并且 确认消息应该包含新的余额信息
    并且 消息应该被更新为包含总额

  场景: 处理支出消息的完整流程
    假设 频道 "12345" 已经有钱包 "微信" 余额为 500.00
    并且 用户在频道 "12345" 发送消息 "#微信 #01月 #2024年\n#支出 80.00元"
    当 我处理这条消息
    那么 消息应该解析成功
    并且 交易应该记录到数据库
    并且 钱包余额应该减少 80.00
    并且 应该发送确认消息给用户
    并且 确认消息应该包含新的余额信息
    并且 消息应该被更新为包含总额

  场景: 处理出账消息的完整流程
    假设 频道 "12345" 已经有钱包 "支付宝" 余额为 1000.00
    并且 用户在频道 "12345" 发送消息 "#支付宝 #12月 #2024年\n#出账 150.00元"
    当 我处理这条消息
    那么 消息应该解析成功
    并且 交易应该记录到数据库
    并且 钱包余额应该减少 150.00
    并且 应该发送确认消息给用户
    并且 确认消息应该包含新的余额信息
    并且 消息应该被更新为包含总额

  场景: 处理入账消息的完整流程
    假设 频道 "12345" 已经有钱包 "银行卡" 余额为 300.00
    并且 用户在频道 "12345" 发送消息 "#银行卡 #03月 #2024年\n#入账 100.00元"
    当 我处理这条消息
    那么 消息应该解析成功
    并且 交易应该记录到数据库
    并且 钱包余额应该增加 100.00
    并且 应该发送确认消息给用户
    并且 确认消息应该包含新的余额信息
    并且 消息应该被更新为包含总额

  场景: 处理无效消息
    假设 用户在频道 "12345" 发送消息 "无效消息"
    当 我处理这条消息
    那么 应该发送错误提示给用户
    并且 错误提示应该包含使用说明

  场景: 处理重复消息
    假设 用户在频道 "12345" 发送消息 "#支付宝 #12月 #2024年\n#收入 100.00元"
    并且 消息已经被处理过
    当 用户再次发送相同的消息
    那么 应该忽略重复消息
    并且 不应该重复记录交易
    并且 应该发送重复消息提示

  场景: 多频道消息隔离
    假设 频道 "12345" 已经有钱包 "支付宝" 余额为 100.00
    并且 频道 "67890" 已经有钱包 "支付宝" 余额为 200.00
    当 用户在频道 "12345" 发送消息 "#支付宝 #12月 #2024年\n#入账 50.00元"
    并且 用户在频道 "67890" 发送消息 "#支付宝 #12月 #2024年\n#入账 30.00元"
    那么 频道 "12345" 的钱包 "支付宝" 余额应该是 150.00
    并且 频道 "67890" 的钱包 "支付宝" 余额应该是 230.00 